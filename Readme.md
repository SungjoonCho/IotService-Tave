
## 홈 IoT 서비스 using by Arduino & Raspberry Pi - 2019.05.25
## 조성준, 박상범

Video : https://drive.google.com/drive/folders/1SHKx7BbS6Tp8XMI0twP9qJsLw6RnZVKr?usp=sharing
<p align="center">
  <img width=1000 src="https://user-images.githubusercontent.com/80872528/117564122-65fcd580-b0e5-11eb-9ef5-217a646b4206.png">
</p>


1. 작품 제목
<pre>
Daily 홈 IoT 서비스
</pre>

2. IoT란?
<pre>
 4차 산업혁명의 핵심 키워드인 Internet of Things, 사물인터넷(IoT)이란 인터넷을 기반으로 모든 사물을 연결하여 사람과 사물, 사물과 사물 간의 정보를 상호 소통하는 지능형 기술 및 서비스이다.
즉, 사물에 센서를 부착해 실시간으로 데이터를 인터넷으로 주고받는 기술이나 환경을 의미한다. 이를 구현하기 위해서는 유형의 사물과 주위 환경으로부터 정보를 얻는 ‘센싱 기술’, 
사물이 인터넷에 연결되도록 지원하는 ‘유무선 통신 및 네트워크 인프라 기술’, 각종 서비스 분야와 형태에 적합하게 정보를 가공하고 처리하거나 각종 기술을 융합하는 ‘서비스 인터페이스 기술’, 
대량의 데이터를 처리하는 ‘빅데이터 기술’이 핵심이다. 사물 추적 과정에서 엄청나게 발생하는 데이터를 잘 활용하기 위해 ‘머신러닝’, ‘딥러닝’같은 효과적인 데이터 분석방식을 도입해야 한다. 
이와 같은 IoT 기술이 확산하면 우리의 생활과 업무 방식이 매우 효율적이고 편리하게 될 것이다. 
</pre>

3. 작품 개요
<pre>
 이 작품은 IoT 기술을 홈 서비스에 접목해 사용자가 더 안전하고 스마트한 삶을 살 수 있도록 해준다. 삶에 녹아들어 편리하면서도 데일리로 이용 가능한 홈 IoT 서비스를 제공하기 위해 
외출하고 귀가할 때 이용 가능한 서비스를 구현했다. 집에 귀가할 때 음성 명령을 내려 현관 외부에 설치된 카메라가 얼굴 인식을 하여 자동으로 잠금이 해제되고 문이 열린다. 
집에서 외출 시에는 음성 명령 하나면 날씨 정보를 분석하여 날마다 필요한 데일리 물품을 준비해준다. 예를 들면 기온, 강수 확률, 미세먼지 농도 등의 날씨 정보 알림을 전달하고 우산, 
미세먼지 마스크, 겉옷 등 외출 시 필요한 물품을 사용자가 쉽게 준비할 수 있도록 도와주는 홈 IoT 서비스를 제공할 것이다. 
</pre>

4. 아이디어 제안 배경
<pre>
(1) 현대인들의 삶에서 매일 사용할 수 있는 기술에 초점을 맞춰 사용이 편리하고 높은 활용성을 고려. 
(2) 신체장애가 있는 사용자를 고려해 기술 사용에 있어서 모든 사람들이 평등하게 사용할 수 있도록 설계, 기술구현 시 자동화 시스템 활용 고려.
(3) 홈 시스템을 더 효율적이고 편리하게 제어하기 위해 무선기술 활용을 고려.
(4) 일상 속에서 필수적인 것임에도 빈번히 놓치는 것 중 하나인 날씨 정보와 날씨에 맞는 데일리 물품을 준비하는데 시간 절약을 시켜 삶의 질을 높임. 
(5) IoT 기술을 활용하여 기존 아날로그 잠금장치보다 효율적이고 보안성을 갖춘 기술 고려.
</pre>

5. 작품 설명
<pre>
1) 아이디어 상세 설명

 이 작품은 음성인식 홈 IoT 기반 시스템이다. 음성인식, 자동화 기술을 활용해 시간은 절약해주면서 삶의 편리성을 증진 시키는 것에 초점을 두어 작품을 만들었다. 
 음성인식은 구글 어시스턴트 API를 사용하였고 음성 명령을 처리하여 하드웨어가 움직일 시에는 블루투스로 명령 신호를 받기 때문에 자동으로 동작을 한다. 
 홈 IoT 서비스는 외출, 귀가 2가지의 상황으로 나누어진다. 
 사용자가 집에 귀가할 때, 기존의 비밀번호를 활용한 아날로그 방식이 아니라 현관 외부에 설치된 카메라가 Open CV를 이용해 사용자의 얼굴 인식을 하도록 하였다. 
 그리고 설정한 사용자가 맞으면 아두이노끼리 블루투스를 이용해 신호를 전달하고 자동으로 잠금장치(Solenoid)를 해제하도록 하여서 비밀번호를 사용하는 불편함을 줄이고 보안성을 높였다. 
 이 때 사용자 얼굴을 스스로 학습할 수 있도록 해주는 OpenCV Face_Recognition 라이브러리를 이용하였는데 딥러닝 기술을 영상 처리와 접목한 대표적인 머신러닝 기술의 예시라고 할 수 있다. 
 다음으로 사용자가 외출 시에 날씨 정보에 관한 음성 명령을 내리면 T developer에서 날씨 데이터를 얻어온다. 데이터가 일정 설정 범위 값 내에 해당하면 데일리 키트를 작동시키기 위해 
 아두이노는 블루투스를 이용해 데일리 키트로 신호를 전달하고 날씨 맞춤형 물품을 자동으로 제공할 것이다. 예를 들면 그 날의 강우량이 70% 이상일 때 데일리 키트 우산 함이 열리고 
 미세먼지 농도가 심하면 미세먼지 마스크 함이 자동으로 열린다. 그리고 구글 어시스턴트 API를 이용하여 날씨 정보를 음성으로 전달할 수 있을 것이다.  
 이 기술을 좀 더 다양하게 응용한다면 기온이 낮을 시에는 핫 팩을 챙길 수 있게, 더울 때는 미니 선풍기를 챙길 수 있도록 활용할 수 있을 것이다. 

  
2) 주요 동작 및 특징

● 현관문 앞에 데일리 키트를 설치하여 비가 오는 날이면 우산, 미세먼지가 심한 날이면 미세먼지 마스크를 자동으로 준비해주는 날씨 맞춤형 서비스를 제공할 것이다. 
음성인식 명령이고 자동으로 데일리 물품을 제공한다.

● 문을 열기 위해 카메라 앞에 얼굴을 보여주면 라즈베리 파이에 부착된 카메라가 미리 설정된 사용자의 얼굴을 인식하여 도어락을 해제할 것이다. 
아날로그 방식의 잠금장치가 아니므로 비밀번호 설정이 필요 없다.

● 음성인식을 활용하였기 때문에 날씨 정보 외에 맛집, 장소 정보들을 구글 어시스턴트에 질문을 하여 답변을 얻을 수 있다.
</pre>

6. 단계별 제작 과정
<pre>
1) 개발 환경 (개발 언어, Tool, 사용 시스템)

● 개발 언어: Python , C
● 사용 H.W : 라즈베리파이, 아두이노 
● 사용 S.W 및 시스템 
   구글 API(음성인식), T developer(날씨정보), 공공데이터 포털 Open API
● 개발 툴: Pycharm, Arduino IDE


● 라즈베리 파이 OS 설치 및 기본 개발 환경 구축

	- 라즈비안 OS를 SD 카드에 설치하여 라즈베리 파이에 꽂고 OS 설치
	- 기본 언어가 영어이므로 한글 키보드 입력 가능하도록 fcitx 설치  (https://mc10sw.tistory.com/14 참조)
	- Arduino를 이용하기위해 Arduino IDE 설치
	- 파이썬 가상 환경에서 진행하므로 가상 환경 모듈 설치
	  cv2, requests, json, numpy, picamera, serial 등 개발에 필요한 모듈 설치
	- cv2 같은 경우는 패키지 파일을 받아서 빌드까지 해야 하므로 윈도우에서의 파이썬    모듈 설치 과정과는 다른 별도의 빌드 과정 수행 필요
	  (https://webnautes.tistory.com/916 참조)


● Google Open API 구글 어시스턴트 구현 (인공 지능 스피커)

	(1) Google Action Console에서 사용자 인증 정보 등록하고 작품 이름, Model ID, Device ID 등 API 사용에 필수적인 항목들 등록
	(2) Google assistant 동작에 필요한 패키지 파일들 설치, credential 파일 다운로드(사용자 개인 인증)
	(3)  파이썬 가상 환경 안에서 사용자 인증 마치고 google sample 스크립트 동작
	(4) 송신하려는 아두이노 신호와 OpenCV 모듈, 라즈베리 파이 영상 처리 모듈들이 google sample 코드 내에서 함께 동작할 수 있도록 한다. 
	Google sample 파일 내의 push to talk 스크립트의 assistant 함수 내에서 조건문을 이용하여 아두이노로 시리얼 통신할 수 있도록 스크립트 수정
	     (경로 : /home/pi/env/lib/python3.5/site-pckages/googlesamples/assistant/grpc/pushtotalk)


2) 아두이노 회로 제작
●  통신 

	- 라즈베리 파이와 아두이노 우노는 시리얼 통신(유선 통신)
	- 아두이노 우노끼리는 블루투스를 이용한 무선 통신
	시리얼 통신을 통해 약속된 신호가 들어오면 Software Serial 라이브러리를 이용하여 블루투스 신호를 송신하고 수신한다.

●  동작
	- 데일리 키트
	수집된 날씨, 미세먼지 정보에 따라 동작시킬 서보 모터를 결정하고 동작시킨다. 전압은 5V 기반으로 동작하며 동일한 +, - 극에 연결되어 있다.

	- 도어락
	 전압은 12V 기반으로 동작하며 어댑터를 통해 전력을 공급받는다. 하지만 아두이노 우노로 어댑터의 220V 전압을 바로 공급하는 것은 큰 손상을 줄 수 있기 때문에 릴레이 모듈을 
	 중간에 연결시켜서 전압을 변환시켜주고 도어락을 동작시키도록 한다.

● 아두이노 회로도
 	<아두이노 블루투스 회로도>

<p align="center">
  <img width="700" src="https://user-images.githubusercontent.com/80872528/117538072-6e9ad080-b03f-11eb-9ff6-dd7c13f2c8cc.png">
</p>

	<아두이노 데일리 키트(using by Servo motor) 회로도>

<p align="center">
  <img width="700" src="https://user-images.githubusercontent.com/80872528/117538114-92f6ad00-b03f-11eb-8051-8089f77d90e3.png">
</p>


	<아두이노 도어락(using by solenoid)>

<p align="center">
  <img width="700" src="https://user-images.githubusercontent.com/80872528/117538159-dcdf9300-b03f-11eb-9668-69831cdf8fde.png">
</p>

</pre>

7. 동작 원리
<pre>
● 날씨 맞춤 서비스 구현

1) 알고리즘

<p align="center">
  <img width="700" src="https://user-images.githubusercontent.com/80872528/117538172-ed900900-b03f-11eb-81a2-0124faf860cb.png">
</p>


2) 상세설명

 - 이용 모듈

	* json : 서버에서 json 형식으로 수신된 데이터를 파이썬 형식으로 타입을 
		 변환하기 위한 모듈
	* serial : 라즈베리 파이와 아두이노를 유선 통신으로 연결하여 구글 어시스턴트(파이썬) 스크립트에서 아두이노로 명령해주기 위한 모듈  
	* requests : 서버에 필요한 정보를 요청하기 위한 모듈


	(1) 라즈베리 파이에 마이크를 연결하여 음성으로 명령을 내린다. 
		(음성인식은 구글 어시스턴트 API 코드를 응용한다.)
		예시 : 오늘 날씨는 어때?


	(2-1) 구글 어시스턴트 API를 이용하여 음성으로 해당 장소의 날씨를 직접 스피커를 통해 들을 수 있도록 한다.

	(2-2) 날씨 API를 T developer라는 홈페이지(sk에서 하는 개발자들 위해서 만든 홈페이지)에서 회원가입하고 key 값을 받는다.

	(3-1) 음성 명령 안에 ‘날씨’라는 키워드가 있다면 파이썬에서 request 모듈을 이용해서 key 값 넣고 서버에 날씨 정보를 요청하여 응답을 받는다. 이
	정보들을 파싱(데이터 가공)해서 필요한 정보인 흐림, 맑음, 기온 등의 정보를 가져온다.

	(3-2) 음성 명령 안에 ‘날씨’라는 키워드가 있다면 위 과정과 마찬가지로 공공 데이터 포털 사이트 서버에 미세먼지 정보를 요청하여 적절한 응답을 받는다. 
	이 정보들을 파싱하여 미세먼지 수치 정보를 가져온다.

	(4) 라즈베리 파이에서 위 정보 데이터들이 설정 값(예: 오늘 날씨 : 비 옴, 미세먼지 농도 80 이상)에 해당하면 아두이노로 블루투스를 이용하여 신호 전달.

	(5) 아두이노는 위 신호를 처리해서 강수 확률이 높다면 데일리 키트에서 우산함이 열리고 미세먼지 농도가 높다면 미세먼지 마스크함이 열리게 설계한다.






● 얼굴 인식을 활용한 음성 도어락 구현

(1) 알고리즘

<p align="center">
  <img width="700" src="https://user-images.githubusercontent.com/80872528/117538203-10222200-b040-11eb-97d0-575405b2e956.png">
</p>



(2) 상세설명

 - 이용 모듈
	* cv2 : 얼굴 인식 활용을 위한 모듈
	* numpy : 얼굴 인식 후 각 프레임을 수치로 변환하여 계산하기 위한 모듈
	* picamera : 일반 OpenCV 프로젝트에서는 외장, 내장 카메라를 이용하지만 라즈베리 파이에서는 외장 소형 부품 카메라를 이용하기 때문에 picamera 모듈을 이용하여 영상 촬영
	* serial : 라즈베리 파이와 아두이노를 유선 통신으로 연결하여 구글 어시스턴트(파이썬) 스크립트에서 아두이노로 명령해주기 위한 모듈  


	(1) 약 100장 ~ 200장의 얼굴 사진을 미리 촬영해놓고 cv2의 모델 훈련 메소드 (LBPHFaceRecognizer_create(), train)를 이용하여 얼굴 모델 훈련

	(2) picamera를 이용하여 얼굴 영상을 실시간으로 촬영한다.

	(3) 촬영한 각 영상 프레임을 흑백 처리 후 CascadeClassifier 메소드를 이용하여 얼굴 부분만 확보한다.

	(4) 확보한 실시간 얼굴과 훈련된 모델을 predict 메소드를 이용하여 비교 후 동일인인지 구분한다.


	(5) 동일인일 확률이 80% 이상이면 아두이노로 시리얼 통신을 이용해 문을 열어달라는 신호 송신한다.

	(6) 라즈베리 파이와 유선 연결된 아두이노에서는 별개의 도어락 아두이노로 블루투스(무선 통신)를 이용해 문을 열어달라는 신호 송신한다. 
	그리고 도어락 아두이노에서는 약속된 신호를 수신하면 문을 열어준다. 

</pre>


8. 작품 구현 설명 영상 

<pre>
* 작품 기능 구현 설명 영상입니다.

https://drive.google.com/drive/folders/1SHKx7BbS6Tp8XMI0twP9qJsLw6RnZVKr?usp=sharing
</pre>
